<!doctype html>
<title>YOLO Inference Web</title>
<style>
  body { font-family: sans-serif; margin: 0; background: #f5f5f5; }
  .container { max-width: 900px; margin: 30px auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #0001; padding: 32px; }
  .section { margin-bottom: 32px; }
  .section-title { font-size: 1.2em; font-weight: bold; margin-bottom: 12px; }
  .row { display: flex; flex-wrap: wrap; gap: 24px; align-items: flex-end; }
  .col { flex: 1 1 0; min-width: 200px; }
  img { width: 100%; max-width: 900px; border-radius: 8px; box-shadow: 0 1px 4px #0002; }
  form { margin-bottom: 0; }
  label { font-weight: 500; }
  input[type=range] { width: 80%; }
  .slider-label { display: flex; align-items: center; gap: 12px; margin: 16px 0; }
  fieldset:disabled { opacity: 0.5; }
  .spinner {
    display: none;
    margin: 0 auto;
    border: 6px solid #f3f3f3;
    border-top: 6px solid #007bff;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    animation: spin 1s linear infinite;
  }
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  .inference-feedback {
    text-align: center;
    margin-top: 12px;
    font-size: 1.1em;
    color: #007bff;
  }
</style>
<div class="container">
  <!-- File selection/upload section -->
  <div class="section">
    <div class="section-title">1. Image files</div>
    <form method=post enctype=multipart/form-data style="margin-bottom:12px;" id="uploadForm">
      <label for="fileInput">Upload a file:</label>
      <input type=file name=file accept="image/*" id="fileInput">
      <input type=submit value="Upload New Image" id="uploadBtn" style="display:none;">
    </form>
    <script>
      document.getElementById('fileInput').addEventListener('change', function() {
        if (this.value) {
          document.getElementById('uploadForm').submit();
        }
      });
    </script>
    <form method=post id="fileSelectForm" style="display:inline;">
      <label for="file_select">Or select an already uploaded file:</label>
      <select name="filename" id="file_select" onchange="this.form.submit()">
        <option value="">-- Select file --</option>
        {% for fname in uploaded_files %}
          <option value="{{ fname }}" {% if fname == uploaded_img %}selected{% endif %}>{{ fname }}</option>
        {% endfor %}
      </select>
      <button type="submit" name="delete_file" value="1" onclick="return confirm('Are you sure you want to delete this file?');" {% if not uploaded_img %}disabled{% endif %}>Delete selected file</button>
    </form>
    {% if uploaded_img %}
      <div style="margin-top:10px; max-width:200px;">
        <img src="{{ url_for('uploaded_file', filename=uploaded_img) }}" alt="Preview" style="width:100%; border-radius:4px; box-shadow:0 1px 4px #0002;">
      </div>
    {% endif %}
  </div>

  <!-- Inference options section -->
  <div class="section">
    <div class="section-title">2. Inference Options</div>
    <form method=post id="inferForm">
      <input type="hidden" name="filename" value="{{ uploaded_img }}">
      <div class="row">
        <div class="col">
          <label>Model:</label>
          <select name="model_path" style="width:100%">
            {% for mpath in model_paths %}
              <option value="{{ mpath }}" {% if mpath == model_path %}selected{% endif %}>{{ mpath.split('/')[-1] }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col">
          <label><input type="checkbox" name="sliding_window" {% if sliding_window %}checked{% endif %}> Sliding Window</label>
        </div>
        <div class="col">
          <label>IOU Threshold:</label><br>
          <input type="number" name="iou_thres" min="0" max="1" step="0.01" value="{{ iou_thres }}">
        </div>
        <div class="col">
          <label>Min Distance:</label><br>
          <input type="number" name="min_dist" min="0" step="1" value="{{ min_dist }}">
        </div>
        <div class="col">
          <input type="submit" name="run_infer" value="Run inference on selected image">
        </div>
      </div>
      <div class="inference-feedback" id="inferenceFeedback">
        <div class="spinner" id="spinner"></div>
        <span id="inferenceMsg"></span>
      </div>
    </form>
  </div>

  <!-- Visualization section -->
  <div class="section">
    <div class="section-title">3. Visualization</div>
    {% if uploaded_img %}
      {% if geojson_exists %}
        <div style="color: #228B22; margin-bottom: 10px;">
          Inference has been calculated for this image.<br>
          <span style="font-size:0.95em; color:#555;">
            Timestamp: {{ geojson_timestamp }}
          </span>
        </div>
      {% else %}
        <div style="color: #B22222; margin-bottom: 10px;">You have to run inference before visualizing.</div>
      {% endif %}
    {% endif %}
    <form method="get" action="{{ url_for('visualize') }}">
      <input type="hidden" name="filename" value="{{ uploaded_img }}">
      <button type="submit" {% if not geojson_exists %}disabled{% endif %}>Visualize</button>
    </form>
  </div>
</div>
<script>
  document.getElementById('inferForm').addEventListener('submit', function() {
    document.getElementById('spinner').style.display = 'inline-block';
    document.getElementById('inferenceMsg').textContent = 'Running inference, please wait...';
  });
  window.onload = function() {
    document.getElementById('spinner').style.display = 'none';
    document.getElementById('inferenceMsg').textContent = '';
  };
</script>